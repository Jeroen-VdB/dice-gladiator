@page "/"
@using System.Text.Json;
@inject GameService GameService;
@inject Blazored.LocalStorage.ILocalStorageService localStorage;
@inject NavigationManager NavigationManager;
@inject ILogger<Game> logger;

<PageTitle>Dice Gladiator</PageTitle>

<CascadingValue Value="GameService">

	<MudGrid Justify="Justify.Center">
		<MudItem xs="12">
			<MudPaper Class="d-flex align-center justify-center mud-width-full py-4 pa-4">
				<EnemyDisplay @ref="EnemyDisplay" />
			</MudPaper>
		</MudItem>

		<EndRound @ref="EndRoundModal" NextRound="Refresh" />

		<MudItem xs="12">
			<MudPaper Class="d-flex align-center justify-center mud-width-full py-8">
				<MudText>Select your dice and get ready to </MudText>
				<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@EndRoundModal.Open">Fight</MudButton>
			</MudPaper>
		</MudItem>

		<MudItem xs="12">
			<MudPaper Class="d-flex align-center justify-center mud-width-full py-8">
				<Leaderboard @ref="Leaderboard" />
			</MudPaper>
		</MudItem>
	</MudGrid>
</CascadingValue>

@code {
	private EnemyDisplay? EnemyDisplay { get; set; }
	private EndRound? EndRoundModal { get; set; }
	private Leaderboard? Leaderboard { get; set; }

	protected override async Task OnInitializedAsync()
	{
		if (GameService.Players.Any())
			return;

		var gameSession = await localStorage.GetItemAsync<GameService>("gameSession");

		if (gameSession != null)
		{
			GameService.ResumePreviousGame(gameSession);

			logger.LogInformation("GameSession: {gamesession}", JsonSerializer.Serialize(gameSession));
			logger.LogInformation("GameService: {GameService}", JsonSerializer.Serialize(GameService));
		}
		else
		{
			NavigationManager.NavigateTo("new-game");
		}
	}

	private void Refresh()
	{
		//Trigger Direct State Change
		logger.LogInformation("NextEnemy: {nextEnemy}", JsonSerializer.Serialize(GameService.CurrentEnemy));
	}
}
